import { EmbedBuilder } from "discord.js";
import { User, Cosmetic, Tag, Inventory, getUser } from "../../utils/database.js";

export default {
  name: "equipar",
  description: "Equipe um banner, √≠cone ou tag do invent√°rio",
  async execute(message, args) {
    if (args.length < 2) {
      return message.reply("‚ùå Use: `!equipar banner {nome}`, `!equipar icon {nome}` ou `!equipar tag {nome}`");
    }

    const tipo = args[0].toLowerCase();
    const nome = args.slice(1).join(" ");

    if (!["banner", "icon", "tag"].includes(tipo)) {
      return message.reply("‚ùå Tipo inv√°lido! Use `banner`, `icon` ou `tag`.");
    }

    let item, possui;

    if (tipo === "tag") {
      item = await Tag.findOne({ where: { name: nome } });
      if (!item) return message.reply("‚ùå Tag n√£o encontrada.");

      // Corrigido: verificar se o usu√°rio possui a tag no invent√°rio
      possui = await Inventory.findOne({
        where: { userId: message.author.id, tagId: item.id }
      });

    } else {
      item = await Cosmetic.findOne({ where: { name: nome, type: tipo } });
      if (!item) return message.reply("‚ùå Cosm√©tico n√£o encontrado.");

      possui = await Inventory.findOne({
        where: { userId: message.author.id, cosmeticId: item.id }
      });
    }

    if (!possui) return message.reply(`‚ùå Voc√™ n√£o possui esse ${tipo}.`);

    // Garantir que o usu√°rio exista
    const user = await getUser(message.author.id);

    // Equipar item
    if (tipo === "banner") user.equippedBanner = item.id;
    else if (tipo === "icon") user.equippedIcon = item.id;
    else if (tipo === "tag") user.equippedTagId = item.id;

    await user.save();

    const embed = new EmbedBuilder()
      .setTitle("üé® Equipado!")
      .setDescription(`Voc√™ equipou **${item.name}${tipo === "tag" && item.tag ? " " + item.tag : ""}** (${tipo}).`)
      .setColor("Blue");

    // Adicionar imagem se for banner ou √≠cone
    if (tipo !== "tag") embed.setImage(item.url);

    return message.channel.send({ embeds: [embed] });
  }
};
